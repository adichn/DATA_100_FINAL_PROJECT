Name: Aditya Chauhan

ID: 169027493

Class: DATA 100 A

Professor: Dr. Devon Becker

Dataset: Air Quality (UC Irvine) (Vito, S. (2008). Air Quality [Dataset]. UCI Machine Learning Repository. <https://doi.org/10.24432/C59K5F>.)

# Introduction

Carbon monoxide (CO) is a toxic air pollutant produced primarily by vehicle emissions and industrial processes. Its concentration in the air is a critical metric for evaluating urban air quality. CO exposure can have adverse effects on public health, particularly for vulnerable populations like children and the elderly. This study aims to explore the factors contributing to carbon monoxide levels and predict these concentrations based on weather and other air quality measurements.

# Research Question: 

Can we develop a reliable model to predict CO concentrations based on temperature, humidity, and sensor data?

# Preprocessing

## Library Loads & Data Imports
```{r}
library(readxl)
library(tidyverse)
library(ggplot2)
library(tidymodels)
library(patchwork)
library(lubridate)
library(zoo)
library(reshape2)
library(dplyr)
library(RColorBrewer)

air_quality_data <- read_excel("AirQualityUCI.xlsx", sheet = "AirQualityUCI")
```

## Creating Categorical Features
```{r}
# Define pollutant columns based on existing column names
pollutant_columns <- c("CO(GT)", "NOx(GT)", "NO2(GT)")

# Grouping by Season and handling outliers in pollutant columns
air_quality_data <- air_quality_data |>
  group_by(Season = case_when(
    format(Date, "%m") %in% c("12", "01", "02") ~ "Winter",
    format(Date, "%m") %in% c("03", "04", "05") ~ "Spring",
    format(Date, "%m") %in% c("06", "07", "08") ~ "Summer",
    format(Date, "%m") %in% c("09", "10", "11") ~ "Autumn"
  )) |>
  mutate(
    across(all_of(pollutant_columns), 
           ~ ifelse(. > quantile(., 0.95, na.rm = TRUE), 
                    median(., na.rm = TRUE), .))
  ) |>
  ungroup()

# Create additional categorical features
air_quality_data <- air_quality_data |>
  mutate(
    DayOfWeek = weekdays(Date),
    
    Weekend = if_else(DayOfWeek %in% c("Saturday", "Sunday"), "Weekend", "Weekday"),
    
    Month = format(Date, "%B"), 
    
    Hour = as.numeric(format(Time, "%H")), 
    TimeOfDay = case_when(
      Hour >= 5 & Hour < 12 ~ "Morning",
      Hour >= 12 & Hour < 17 ~ "Afternoon",
      Hour >= 17 & Hour < 21 ~ "Evening",
      TRUE ~ "Night"
    ),
    
    # Temperature Categories
    TempCategory = case_when(
      T < 10 ~ "Cold",
      T >= 10 & T <= 25 ~ "Moderate",
      T > 25 ~ "Hot"
    ),
    
    # Humidity Levels
    HumidityLevel = case_when(
      RH < 30 ~ "Low",
      RH >= 30 & RH <= 60 ~ "Medium",
      RH > 60 ~ "High"
    )
  )

```

## Other Preprocessing

```{r}
# Handling missing values
air_quality_data <- air_quality_data |>
  mutate(
    across(c(`NOx(GT)`, `NO2(GT)`), ~ na_if(., -200))
  ) |>
  drop_na() 

# Normalize / Standardize Cont. Vars
air_quality_data <- air_quality_data |>
  mutate(
    across(c(T, RH, AH), ~ (. - mean(., na.rm = TRUE)) / sd(., na.rm = TRUE))
  )

# Interaction term
air_quality_data <- air_quality_data |>
  mutate(
    Temp_Humidity_Interaction = T * RH,
    CO_Temp_Interaction = `CO(GT)` * T
  )

# Rolling average
air_quality_data <- air_quality_data |>
  arrange(Date, Time) |> # Ensure data is sorted chronologically
  mutate(
    Rolling_CO = rollmean(`CO(GT)`, k = 5, fill = NA)
  )

# Correlation Matrix
numeric_cols <- air_quality_data |>
  select(where(is.numeric))
cor_matrix <- cor(numeric_cols, use = "complete.obs")
#print(cor_matrix)

# Correlation Matrix Plot
numeric_cols <- air_quality_data |>
  select(where(is.numeric))

cor_matrix <- cor(numeric_cols, use = "complete.obs")
cor_melt <- melt(cor_matrix)

ggplot(cor_melt, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile(color = "white") + 
  scale_fill_gradient2(low = "blue", high = "red", mid = "white",
                       midpoint = 0, limit = c(-1, 1), space = "Lab",
                       name = "Correlation") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)
  ) + 
  labs(title = "Correlation Matrix", x = "Features", y = "Features")

# Split dataset
set.seed(123)
data_split <- initial_split(air_quality_data, prop = 0.7)
train_data <- training(data_split)
test_data <- testing(data_split)

```


# Exploratory Analysis

```{r}
# Define dynamic ranges for CO(GT) and other key variables
co_gt_limits <- c(-10, 10) # Adjusted for better scaling based on actual values
ozone_sensor_limits <- c(200, 2500) # For ozone sensor data
temp_limits <- c(-10, 40) # Temperature range

# 1. Relationship Between NOx(GT) and CO(GT)
plot1 <- ggplot(air_quality_data, aes(x = `NOx(GT)`, y = `CO(GT)`)) +
  geom_point(alpha = 0.6, color = "steelblue", size = 1) +
  geom_smooth(method = "lm", se = TRUE, color = "darkred", linetype = "dashed", size = 1) +
  scale_y_continuous(limits = co_gt_limits) +
  scale_x_continuous(limits = c(0, 500)) +
  labs(title = "NOx(GT) vs CO(GT)",
       x = "NOx(GT) (Nitrogen Oxides)",
       y = "CO(GT) (Carbon Monoxide)") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold"))

# 4. Sensor Data vs CO(GT)
plot4 <- ggplot(air_quality_data, aes(x = `PT08.S1(CO)`, y = `CO(GT)`)) +
  geom_point(alpha = 0.5, aes(color = `PT08.S1(CO)`), size = 1.5) +
  geom_smooth(method = "lm", se = TRUE, color = "darkgreen", linetype = "solid", size = 1) +
  scale_color_gradient(low = "yellow", high = "red") +
  scale_y_continuous(limits = co_gt_limits) +
  scale_x_continuous(limits = c(0, 2000)) +
  labs(title = "Sensor Data vs CO(GT)",
       x = "PT08.S1(CO) (Sensor Data)",
       y = "CO(GT) (Carbon Monoxide)",
       color = "Sensor Value") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold"))

# 5. Seasonal Trends in CO(GT)
plot5 <- ggplot(air_quality_data, aes(x = Season, y = `CO(GT)`, fill = Season)) +
  geom_boxplot(outlier.shape = 21, outlier.fill = "red", outlier.size = 2, alpha = 0.7) +
  scale_fill_brewer(palette = "Pastel2") +
  scale_y_continuous(limits = co_gt_limits) +
  labs(title = "Seasonal Trends in CO(GT)",
       x = "Season",
       y = "CO(GT) (Carbon Monoxide)") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold"),
        legend.position = "none")

# 7. NOx(GT) vs Ozone Sensor Data
plot7 <- ggplot(air_quality_data, aes(x = `NOx(GT)`, y = `PT08.S5(O3)`)) +
  geom_point(alpha = 0.5, color = "cyan", size = 1.5) +
  geom_smooth(method = "lm", se = TRUE, color = "blue", size = 1.2, linetype = "solid") +
  scale_y_continuous(limits = ozone_sensor_limits) +
  scale_x_continuous(limits = c(0, 500)) +
  labs(title = "NOx(GT) vs Ozone Sensor",
       x = "NOx(GT) (Nitrogen Oxides)",
       y = "PT08.S5(O3) (Ozone Sensor)") +
  theme_minimal(base_size = 12) +
  theme(plot.title = element_text(face = "bold"))

# Arrange plots with spacing and better proportions
final_plot <- (plot1 | plot4) / (plot5 | plot7)  +
  plot_layout(guides = "collect") & theme(legend.position = "bottom")

# Render the final plot
final_plot
```